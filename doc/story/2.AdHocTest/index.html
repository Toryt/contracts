<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Ad Hoc Test</title>
  <link href="../../lib/prism/prism.css" rel="stylesheet"/>
</head>
<body>

<p>The solution to our problems is to work with contracts. We should explicitly
  mention (all?) <em>preconditions</em> the implementation depends on,
  and all <em>postconditions</em> we, as implementer, want to guarantee.
  We know the theory. The rest of this story is about how to make it tractable to
  do that.</p>
<p>The first step is to introduce the
  <a href="#code.3-10">pre-</a> and
  <a href="#code.26-38">postconditions</a>
  with <em>ad hoc</em> code.</p>
<p>The <a href="#code.12-24">implementation</a> itself is the basically same, except</p>
<ul>
  <li>that we introduced a <a href="#code.19-21">programming error</a>
    for demonstration purposes, for <code class="language-javascript">fibonacci(8)</code>:
    that will return -3, instead of the nominally expected 21;</li>
  <li>that we cannot return a result immediately in the conditional statements, but that
    we need to store the result in a <a href="#code.12">variable</a>, so that we can
    put it through <a href="#code.26-38">postcondition</a> validation.</li>
</ul>
<p>The latter means that we need to change the control flow from the original implementation.
  All in all, it is annoying.</p>
<pre id="code" class="line-numbers" data-src="code.js"
     data-line="3-10,4-6,7-9,12-24,12,19-21,26-38,27-29,30-32,33-37"></pre>
<div id="prism-eval-output"></div>



<h1>Preconditions</h1>

<p>In the <a href="#code.3-10">preconditions</a> we mention explicitly
  that we expect <a href="#code.4-6"><code class="language-javascript">n</code> to be an integer</a>,
  and that we expect it to be a <a href="code.7-9">positive number</a>.
  Violations are reported here by throwing. We wont go into the details of what to throw best now,
  but we make sure that we report precisely what we except, what we got, and why this is a violation.</p>
<p>The call <code class="language-javascript">fibonacci(&quot;a&quot;)</code> gives:</p>
<div id="prism-eval-output-callWithA"></div>
<p>We immediately see that a precondition was violated, that the parameter
  <code class="language-javascript">n</code> was expected to be an integer, but was
  the string <code class="language-javascript">&quot;a&quot;</code> instead.</p>
<p>When we call <code class="language-javascript">fibonacci</code>
  with the integers from -1 to 9, the call with -1 results in a precondition violation
  being reported. It clearly states that, and that <code class="language-javascript">n</code> was expected
  to be positive or 0, but was -1. The calls with 1 through 9 are discussed below.</p>
<div id="prism-eval-output-callWithI"></div>



<h1>Postconditions</h1>

<p>The <a href="#code.26-38">postconditions</a> describe the nominal result in 3 steps:</p>
<ul>
  <li>if <code class="language-javascript">n === 0</code>, the result should be 0;</li>
  <li>if <code class="language-javascript">n === 1</code>, the result should be 1;</li>
  <li>if <code class="language-javascript">2 ≤ n</code>, the result should be the sum of the
    Fibonacci number of <var>n - 1</var> and <var>n - 2</var>.</li>
</ul>
<p>Again, violations are reported by throwing. We make
  sure that we report precisely what we except, what we got, and why this is a violation.</p>
<p>When we call <code class="language-javascript">fibonacci</code>
  with the integers from 0 to 7, we see numbers as result, and we know for sure now that these
  results follow this definition. The computer double checked.</p>
<p>We see that the call <code class="language-javascript" data-eval="true" data-output="8">fibonacci(8)</code>
  fails: <span id="8"></span>. We can read that a postcondition was violated:
  if <code class="language-javascript">2 ≤ n</code>, then
  <code class="language-javascript">result</code>
  should be <code class="language-javascript">fibonacci(n - 1) + fibonacci(n - 2)</code>.
  In this case <code class="language-javascript">n</code> is 8, so it is indeed 2 or larger,
  and <code class="language-javascript">result</code> turned out to be -3, which is not
  13 + 8, the sum of the results of <code class="language-javascript">fibonacci(8 - 1)</code>
  and <code class="language-javascript">fibonacci(8 - 2)</code>. This is the
  <a href="#code.19-21">programming error</a> we introduced.</p>
<p>Finally we see that the call <code class="language-javascript" data-eval="true" data-output="9">fibonacci(9)</code>
  fails in the same way: <span id="9"></span>. We can read exactly which postcondition was violated
  <em>on which call</em>: <code class="language-javascript">fibonacci(8)</code>
  (during evaluation of <code class="language-javascript">fibonacci(9)</code>).</p>



<h1>Conclusion</h1>

<p>With the introduction of explicit <a href="#code.3-10">pre-</a> and <a href="#code.26-38">postconditions</a>
  with <em>ad hoc</em> code, with handcrafted reporting, we get to the point reporting of our programming errors.</p>
<p>The disadvantages are clear:</p>
<ul>
  <li>The handcrafted aspect is a big negative. It will take ages to write all code like this,
    and the <a href="#code.3-10">pre-</a> and <a href="#code.26-38">postconditions</a> are code itself,
    with its own complexity. It is not unlikely that this code will contain errors itself.</li>
  <li>We needed to change our algorithm. A <a href="#code.12">variable</a> needed to be introduced,
    and we needed to change the control flow to allow for postcondition validation.</li>
  <li>We have little or no encapsulation or separation-of-concerns. The
    <a href="#code.12-24">nominal implementation</a>
    is huddled together with the <a href="#code.3-10">pre-</a> and
    <a href="#code.26-38">postconditions</a>. We needed comments to bring structure to the mess.</li>
</ul>
<p>Note also that there are now 19 lines of validation, for 12 lines of nominal code.
  That seems out of balance, but I wont mention it as a disadvantage. If this is what it takes, it
  is worth it, trust me.</p>
<p>But I'm sure we can do better. Let's start on that path.</p>

<script src="../../lib/prism/prism.js"></script>
<script src="code.js"></script>
<script src="../exec1.js"></script>

</body>
</html>
